---
layout: post
title: 使用Xposed框架进行hook
key: 20150103
tags: Android Reverse
---
xposed创建教程参考 [Android Studio Xposed模块编写](https://www.cnblogs.com/gordon0918/p/6689883.html)  
[没有Android基础都能学会的Xposed基础教程](http://www.freebuf.com/articles/terminal/164741.html)  
最后创建完毕就是这个样子  
![Desktop Preview](https://raw.githubusercontent.com/la0s/la0s.github.io/master/screenshots/20180620.1.png)  
这里我已经编译好了，可以直接用我的模块修改就行 https://github.com/la0s/XposedHookDemo  
这里针对一个APP进行逆向，打印一下它的某些关键参数和签名  
使用JEB进行反编译后

![Desktop Preview](https://raw.githubusercontent.com/la0s/la0s.github.io/master/screenshots/20180620.2.png)

![Desktop Preview](https://raw.githubusercontent.com/la0s/la0s.github.io/master/screenshots/20180620.3.png)

我们使用xposed来hook一下getSign方法 它的参数和返回值  
代码解释
```java
public class XposedHook implements IXposedHookLoadPackage {
    @Override
    public void handleLoadPackage(XC_LoadPackage.LoadPackageParam loadPackageParam) throws Throwable {

        if (loadPackageParam.packageName.equals("cn.thecover.www.covermedia")) {    //过滤包名
            Class clasz = loadPackageParam.classLoader.loadClass("cn.thecover.www.covermedia.data.entity.HttpRequestEntity"); //要hook的方法所在的类名

            XposedHelpers.findAndHookMethod(clasz, "getSign",String.class,String.class,String.class, new XC_MethodHook() { //要hook的方法名和参数类型，此处为三个String类型

                @Override
                protected void beforeHookedMethod(MethodHookParam param) throws Throwable {

                    Log.i("hook before param1:", (String) param.args[0]); //打印第一个参数
                    Log.i("hook before param2:", (String) param.args[1]); 
                    Log.i("hook before param3:", (String) param.args[2]); 

                }

                @Override
                protected void afterHookedMethod(MethodHookParam param) throws Throwable {

                    Log.i("hook after result:",param.getResult().toString()); //打印返回值（String类型）
                }
            });
        }
    }
}
```
装上模块后重启，点击应用，打开DDMS过滤

![Desktop Preview](https://raw.githubusercontent.com/la0s/la0s.github.io/master/screenshots/20180620.4.png)

上面这个新闻APP到了最新版4.2.0之后变成了梆梆加壳，那么我们如果再使用xposed的话需要一个Timing模板来hook加固后的应用  
步骤参考[三分钟学会Hook加固后应用](https://monkeylord.github.io/2018/03/29/%E4%B8%89%E5%88%86%E9%92%9F%E5%AD%A6%E4%BC%9AHook%E5%8A%A0%E5%9B%BA%E5%90%8E%E5%BA%94%E7%94%A8(%E5%90%AB%E5%AE%9E%E9%AA%8C)/)  
最后使用模板创建完了如下图，这里获得加壳应用的方法名可以用TraceView打印或者用FDex2脱壳后逆向查找

![Desktop Preview](https://raw.githubusercontent.com/la0s/la0s.github.io/master/screenshots/20180712.1.png)

同样我把创建好了的AS项目源码放在了我的仓库里 https://github.com/la0s/XposedShell  
直接下载编译即可  
装了之后重启，运行APP，查看xposed日志

![Desktop Preview](https://raw.githubusercontent.com/la0s/la0s.github.io/master/screenshots/20180712.2.png)

可以看到xposed成功hook到了加壳的APP的方法的参数和返回值。
